{
  "scenario_id": "08-liveness-readiness",
  "difficulty": "medium",
  "duration": "20 min",
  "commands": [
    {
      "name": "Step 1: Create Namespace",
      "command": "kubectl create namespace scenarios --dry-run=client -o yaml | kubectl apply -f -",
      "description": "Create scenarios namespace",
      "explanation": "Creates namespace for probe testing.",
      "what_it_does": "Creates 'scenarios' namespace if needed.",
      "next_step": "Deploy application with health probes configured."
    },
    {
      "name": "Step 2: Deploy Application with Probes",
      "command": "kubectl apply -f k8s-scenarios/08-liveness-readiness/deployment.yaml -f k8s-scenarios/08-liveness-readiness/service.yaml -n scenarios",
      "description": "Deploy deployment and service with liveness and readiness probes",
      "explanation": "Creates deployment and service with both probe types configured. Liveness probe checks /healthz every 3s after 3s delay. Readiness probe checks /healthz every 5s after 5s delay. This deployment uses k8s.gcr.io/liveness image which simulates probe failures.",
      "what_it_does": "Creates deployment 'probes-demo-app' and service 'probes-demo-service' with 2 replicas.",
      "next_step": "Check pods are running with probes active."
    },
    {
      "name": "Step 3: Verify Pods Running",
      "command": "kubectl get pods -n scenarios -l app=probes-demo",
      "description": "Check pod status",
      "explanation": "Should see 2 pods in Running state. Both probes must pass for pods to be Running and Ready.",
      "what_it_does": "Lists probes-demo pods.",
      "next_step": "View probe configuration."
    },
    {
      "name": "Step 4: Describe Pod Probes",
      "command": "kubectl describe pod -n scenarios -l app=probes-demo | grep -A 5 'Liveness\\|Readiness'",
      "description": "View configured probes",
      "explanation": "Shows liveness and readiness probe configurations including paths, delays, periods, and thresholds.",
      "what_it_does": "Displays probe configurations from pod spec.",
      "next_step": "Check probe events."
    },
    {
      "name": "Step 5: Watch Probe Events",
      "command": "kubectl get events -n scenarios --field-selector involvedObject.kind=Pod --sort-by='.lastTimestamp' | tail -20",
      "description": "See recent pod events including probe results",
      "explanation": "Look for 'Liveness probe failed' or 'Readiness probe failed' events. Initially all should be passing.",
      "what_it_does": "Lists recent pod events sorted by time.",
      "next_step": "Simulate liveness probe failure."
    },
    {
      "name": "Step 6: Wait for Automatic Failure",
      "command": "sleep 15 && kubectl get pods -n scenarios -l app=probes-demo",
      "description": "Wait for liveness image to automatically fail",
      "explanation": "The k8s.gcr.io/liveness image automatically starts returning HTTP 500 after 10 seconds. After 3 probe failures (failureThreshold: 3), Kubernetes will restart the containers. This sleep gives it time to fail and restart.",
      "what_it_does": "Waits 15 seconds then checks pod status.",
      "next_step": "Watch for restarts."
    },
    {
      "name": "Step 7: Watch Pod Restart",
      "command": "kubectl get pods -n scenarios -l app=probes-demo --watch",
      "description": "Monitor pod restarts from liveness failures",
      "explanation": "The containers will restart every ~40 seconds as they repeatedly fail health checks. You'll see RESTARTS count increment. Liveness failure triggers container restart (not pod deletion). Press Ctrl+C to stop watching.",
      "what_it_does": "Streams live pod status showing restarts.",
      "next_step": "Verify restart count increased."
    },
    {
      "name": "Step 8: Check Restart Count",
      "command": "kubectl get pods -n scenarios -l app=probes-demo",
      "description": "Verify RESTARTS column increased",
      "explanation": "RESTARTS column shows how many times containers have been restarted. Should be 1 or more after liveness failure. This proves liveness probe auto-recovery.",
      "what_it_does": "Displays pod restart counts.",
      "next_step": "Test readiness probe separately."
    },
    {
      "name": "Step 9: Check Service Endpoints",
      "command": "kubectl get endpoints probes-demo-service -n scenarios",
      "description": "View service endpoint list",
      "explanation": "Shows which pod IPs are included in the service. Only Ready pods are listed. If a pod fails readiness, it's removed from here (but pod stays running).",
      "what_it_does": "Lists pod IPs receiving traffic from service.",
      "next_step": "Review what you learned in the summary."
    },
    {
      "name": "Summary: What You Learned",
      "command": "echo 'Scenario complete! Review the summary below.'",
      "description": "Scenario completion summary",
      "explanation": "Congratulations! You've completed the Liveness and Readiness Probes scenario.",
      "what_it_does": "Displays completion message.",
      "next_step": "Ready for cleanup!",
      "show_yaml": true,
      "summary": {
        "key_learnings": [
          "Liveness probes detect and restart unhealthy containers automatically",
          "Readiness probes control when pods receive traffic from services",
          "Probes use httpGet checks with configurable delays, periods, and thresholds",
          "Failed liveness probes trigger container restarts (RESTARTS counter increments)",
          "Failed readiness probes remove pods from service endpoints without restarting them",
          "Combining both probe types ensures high availability and prevents traffic to unready pods",
          "The k8s.gcr.io/liveness image simulates failures for testing probe behavior"
        ],
        "commands_used": [
          {
            "command": "kubectl create namespace",
            "purpose": "Create isolated namespace for scenario resources"
          },
          {
            "command": "kubectl apply -f deployment.yaml",
            "purpose": "Deploy application with liveness and readiness probes configured"
          },
          {
            "command": "kubectl get pods",
            "purpose": "Check pod status and verify probes are working"
          },
          {
            "command": "kubectl describe pod",
            "purpose": "View detailed probe configurations and settings"
          },
          {
            "command": "kubectl get events",
            "purpose": "Monitor probe success/failure events in real-time"
          },
          {
            "command": "kubectl get pods --watch",
            "purpose": "Watch live pod status to see restarts from liveness failures"
          },
          {
            "command": "kubectl get endpoints",
            "purpose": "Verify which pods are receiving traffic based on readiness status"
          }
        ]
      }
    },
    {
      "name": "Cleanup: Delete Resources",
      "command": "kubectl delete -f k8s-scenarios/08-liveness-readiness/deployment.yaml -f k8s-scenarios/08-liveness-readiness/service.yaml -n scenarios",
      "description": "Remove deployment and service",
      "explanation": "Deletes all resources created in this scenario.",
      "what_it_does": "Removes deployment and service.",
      "next_step": "Cleanup complete!",
      "cleanup": true
    }
  ]
}