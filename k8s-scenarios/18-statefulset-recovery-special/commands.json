{
  "scenario_id": "18-statefulset-recovery-special",
  "difficulty": "hard",
  "duration": "40 min",
  "commands": [
    {
      "name": "Step 1: Create Namespace",
      "command": "kubectl create namespace scenarios --dry-run=client -o yaml | kubectl apply -f -",
      "description": "Create scenarios namespace",
      "explanation": "Creates namespace for StatefulSet persistence testing.",
      "what_it_does": "Creates 'scenarios' namespace if needed.",
      "next_step": "Deploy StatefulSet with persistent storage."
    },
    {
      "name": "Step 2: Deploy StatefulSet",
      "command": "kubectl apply -f statefulset.yaml -n scenarios",
      "description": "Deploy PostgreSQL StatefulSet with 3 replicas",
      "explanation": "Creates headless service and StatefulSet. Each pod gets: stable name (postgres-sts-0/1/2), stable network identity (DNS), and persistent volume claim. Perfect for databases requiring stable identity.",
      "what_it_does": "Creates postgres-headless service and postgres-sts StatefulSet with 3 replicas.",
      "next_step": "Watch ordered pod creation."
    },
    {
      "name": "Step 3: Watch Ordered Creation",
      "command": "kubectl get pods -n scenarios -l app=postgres-sts -w",
      "description": "Monitor sequential pod startup (Ctrl+C when all Running)",
      "explanation": "Pods create in order: postgres-sts-0 must be Running before postgres-sts-1 starts. This ordered startup is critical for stateful apps like databases. Press Ctrl+C when all 3 Running.",
      "what_it_does": "Streams pod creation showing ordered behavior.",
      "next_step": "Verify PVCs were created."
    },
    {
      "name": "Step 4: List PVCs",
      "command": "kubectl get pvc -n scenarios",
      "description": "View PersistentVolumeClaims for each pod",
      "explanation": "Should see 3 PVCs: data-postgres-sts-0, data-postgres-sts-1, data-postgres-sts-2. Each pod has its own PVC which persists even if pod is deleted.",
      "what_it_does": "Lists all PVCs with their status and capacity.",
      "next_step": "Write test data to prove persistence."
    },
    {
      "name": "Step 5: Write Data to Pod-0",
      "command": "kubectl exec postgres-sts-0 -n scenarios -- psql -U postgres -c \"CREATE TABLE test_data (id SERIAL PRIMARY KEY, message TEXT, created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);\"",
      "description": "Create test table in PostgreSQL",
      "explanation": "Creates a table in postgres-sts-0's database. This data is written to the PVC, not the pod filesystem.",
      "what_it_does": "Creates database table in persistent storage.",
      "next_step": "Insert test data."
    },
    {
      "name": "Step 6: Insert Test Data",
      "command": "kubectl exec postgres-sts-0 -n scenarios -- psql -U postgres -c \"INSERT INTO test_data (message) VALUES ('Data before pod deletion'), ('Testing persistence'), ('Should survive pod restart');\"",
      "description": "Insert 3 rows of test data",
      "explanation": "Inserts data into the table. This data lives in the PVC and must survive pod deletion to prove persistence works.",
      "what_it_does": "Writes test data to database.",
      "next_step": "Verify data was written."
    },
    {
      "name": "Step 7: Verify Data Exists",
      "command": "kubectl exec postgres-sts-0 -n scenarios -- psql -U postgres -c \"SELECT * FROM test_data;\"",
      "description": "Query data to confirm it was written",
      "explanation": "Should show 3 rows. Note the data before deleting the pod - it must be identical after pod recreation.",
      "what_it_does": "Queries database to show test data.",
      "next_step": "Delete pod to test persistence."
    },
    {
      "name": "Step 8: Delete Pod-0",
      "command": "kubectl delete pod postgres-sts-0 -n scenarios",
      "description": "Delete pod to test data persistence",
      "explanation": "StatefulSet immediately recreates postgres-sts-0 (same name) and reattaches the same PVC (data-postgres-sts-0). If persistence works, data survives.",
      "what_it_does": "Triggers pod deletion and automatic recreation.",
      "next_step": "Wait for pod recreation."
    },
    {
      "name": "Step 9: Wait for Recreation",
      "command": "kubectl wait --for=condition=Ready pod/postgres-sts-0 -n scenarios --timeout=120s",
      "description": "Wait for new postgres-sts-0 to be Ready",
      "explanation": "Waits up to 2 minutes for pod to recreate and be Ready. Same name, same PVC, fresh pod.",
      "what_it_does": "Blocks until pod is Ready or timeout.",
      "next_step": "Verify data survived deletion."
    },
    {
      "name": "Step 10: Verify Data Survived",
      "command": "kubectl exec postgres-sts-0 -n scenarios -- psql -U postgres -c \"SELECT * FROM test_data;\"",
      "description": "Query data from recreated pod",
      "explanation": "Should show the same 3 rows! Data survived pod deletion because it's stored in the PVC, not the pod. This proves StatefulSet persistence.",
      "what_it_does": "Verifies data persisted through pod deletion.",
      "next_step": "Test mass deletion."
    },
    {
      "name": "Step 11: Delete All Pods",
      "command": "kubectl delete pods -l app=postgres-sts -n scenarios",
      "description": "Delete all 3 pods simultaneously",
      "explanation": "Extreme test: delete all StatefulSet pods at once. StatefulSet recreates them in order (0, 1, 2) with same PVCs. All data should survive.",
      "what_it_does": "Deletes all StatefulSet pods.",
      "next_step": "Watch ordered recreation."
    },
    {
      "name": "Step 12: Watch Mass Recreation",
      "command": "kubectl get pods -n scenarios -l app=postgres-sts -w",
      "description": "Monitor all pods recreating in order (Ctrl+C when all Running)",
      "explanation": "Pods recreate sequentially: postgres-sts-0 first, then 1, then 2. Each reattaches its original PVC. Press Ctrl+C when all Running.",
      "what_it_does": "Streams pod recreation showing ordered recovery.",
      "next_step": "Verify data still intact."
    },
    {
      "name": "Step 13: Final Data Verification",
      "command": "kubectl exec postgres-sts-0 -n scenarios -- psql -U postgres -c \"SELECT * FROM test_data;\"",
      "description": "Confirm data survived mass pod deletion",
      "explanation": "Should still show 3 original rows. Data survived complete StatefulSet restart! This is the power of persistent storage with stable identity.",
      "what_it_does": "Final verification of data persistence.",
      "next_step": "Test scale down/up persistence."
    },
    {
      "name": "Step 14: Scale Down",
      "command": "kubectl scale statefulset postgres-sts --replicas=1 -n scenarios",
      "description": "Scale down to 1 replica",
      "explanation": "Scales down to postgres-sts-0 only. Pods 1 and 2 deleted but their PVCs remain! This is by design - data preserved for scale-up.",
      "what_it_does": "Reduces StatefulSet to 1 replica.",
      "next_step": "Verify PVCs remain."
    },
    {
      "name": "Step 15: Verify PVCs Remain",
      "command": "kubectl get pvc -n scenarios",
      "description": "Confirm all 3 PVCs still exist",
      "explanation": "Should still see data-postgres-sts-0, data-postgres-sts-1, data-postgres-sts-2. PVCs are NOT deleted during scale-down - data is preserved.",
      "what_it_does": "Shows PVCs persisted through scale-down.",
      "next_step": "Scale back up."
    },
    {
      "name": "Step 16: Scale Back Up",
      "command": "kubectl scale statefulset postgres-sts --replicas=3 -n scenarios",
      "description": "Scale back up to 3 replicas",
      "explanation": "Pods postgres-sts-1 and postgres-sts-2 recreate and reattach their original PVCs. Any data written to them before scale-down is still there!",
      "what_it_does": "Restores StatefulSet to 3 replicas.",
      "next_step": "Scenario complete! Persistence proven under chaos."
    },
    {
      "name": "Cleanup: Delete StatefulSet",
      "command": "kubectl delete statefulset postgres-sts -n scenarios",
      "description": "Remove StatefulSet (PVCs remain!)",
      "explanation": "Deletes StatefulSet and pods. PVCs are NOT automatically deleted - must delete manually to free storage.",
      "what_it_does": "Removes StatefulSet, keeping PVCs.",
      "next_step": "Delete PVCs to free storage.",
      "cleanup": true
    },
    {
      "name": "Cleanup: Delete PVCs",
      "command": "kubectl delete pvc -l app=postgres-sts -n scenarios",
      "description": "Delete PVCs to free storage (DATA WILL BE LOST)",
      "explanation": "Deletes all StatefulSet PVCs. This frees storage but permanently deletes data. In production, back up first!",
      "what_it_does": "Removes all PVCs, deleting stored data.",
      "next_step": "Delete service.",
      "cleanup": true
    },
    {
      "name": "Cleanup: Delete Service",
      "command": "kubectl delete service postgres-headless -n scenarios",
      "description": "Remove headless service",
      "explanation": "Deletes the headless service used for StatefulSet DNS.",
      "what_it_does": "Removes postgres-headless service.",
      "next_step": "Cleanup complete! Run validate.sh to confirm.",
      "cleanup": true
    }
  ]
}