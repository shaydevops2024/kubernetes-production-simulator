{
  "difficulty": "medium",
  "duration": "25 min",
  "commands": [
    {
      "name": "Step 1: Create Namespace",
      "command": "kubectl create namespace scenarios --dry-run=client -o yaml | kubectl apply -f -",
      "description": "Create scenarios namespace",
      "explanation": "Creates namespace for StatefulSet testing.",
      "what_it_does": "Creates 'scenarios' namespace if needed.",
      "next_step": "Deploy StatefulSet with persistent storage."
    },
    {
      "name": "Step 2: Deploy StatefulSet",
      "command": "kubectl apply -f k8s-scenarios/10-statefulset-operations/statefulset.yaml -f k8s-scenarios/10-statefulset-operations/service.yaml -n scenarios",
      "description": "Deploy StatefulSet and headless service with 3 replicas and PVCs",
      "explanation": "Creates headless service and StatefulSet. Each pod gets a stable name (sts-demo-app-0, sts-demo-app-1, sts-demo-app-2) and its own PersistentVolumeClaim. Pods are created sequentially (ordered).",
      "what_it_does": "Creates service 'sts-demo-headless' and StatefulSet 'sts-demo-app'.",
      "next_step": "Watch ordered pod creation."
    },
    {
      "name": "Step 3: Watch Ordered Creation",
      "command": "kubectl get pods -n scenarios -l app=sts-demo-app --watch",
      "description": "Monitor sequential pod startup",
      "explanation": "Pods create in order: sts-demo-app-0 must be Running before sts-demo-app-1 starts, and so on. This ordered startup is a StatefulSet guarantee. Press Ctrl+C when all 3 are Running.",
      "what_it_does": "Streams live pod creation status.",
      "next_step": "Verify stable pod names."
    },
    {
      "name": "Step 4: List Pods with IPs",
      "command": "kubectl get pods -n scenarios -l app=sts-demo-app -o wide",
      "description": "See stable pod names and IPs",
      "explanation": "Pod names are predictable: sts-demo-app-0, sts-demo-app-1, sts-demo-app-2. These names never change, even if pods are deleted and recreated.",
      "what_it_does": "Lists pods with their stable identities.",
      "next_step": "Check PVCs were created."
    },
    {
      "name": "Step 5: List PVCs",
      "command": "kubectl get pvc -n scenarios",
      "description": "View PersistentVolumeClaims",
      "explanation": "Each pod has its own PVC: data-sts-demo-app-0, data-sts-demo-app-1, data-sts-demo-app-2. These persist even if pods are deleted. Storage survives pod lifecycle.",
      "what_it_does": "Lists all PVCs with their status and capacity.",
      "next_step": "Write data to test persistence."
    },
    {
      "name": "Step 6: Write Test Data",
      "command": "kubectl exec sts-demo-app-0 -n scenarios -- sh -c 'echo \"Hello from sts-demo-app-0\" > /usr/share/nginx/html/data.txt'",
      "description": "Write file to pod-0's persistent storage",
      "explanation": "Creates a file in the mounted volume. This data is stored in the PVC, not the pod filesystem. It will survive pod deletion.",
      "what_it_does": "Creates test file in persistent volume.",
      "next_step": "Delete pod to test data persistence."
    },
    {
      "name": "Step 7: Delete Pod-0",
      "command": "kubectl delete pod sts-demo-app-0 -n scenarios",
      "description": "Delete pod to test recreation with same identity",
      "explanation": "StatefulSet immediately recreates sts-demo-app-0 (same name) and reattaches the same PVC. Data survives because it's in the PVC, not the pod.",
      "what_it_does": "Triggers pod deletion and automatic recreation.",
      "next_step": "Wait for pod recreation."
    },
    {
      "name": "Step 8: Wait for Recreation",
      "command": "kubectl wait --for=condition=Ready pod/sts-demo-app-0 -n scenarios --timeout=60s",
      "description": "Wait for new sts-demo-app-0 to be Ready",
      "explanation": "Waits up to 60s for the recreated pod to be Ready. Same name, same PVC, data preserved.",
      "what_it_does": "Blocks until pod is Ready or timeout.",
      "next_step": "Verify data survived deletion."
    },
    {
      "name": "Step 9: Verify Data Persisted",
      "command": "kubectl exec sts-demo-app-0 -n scenarios -- cat /usr/share/nginx/html/data.txt",
      "description": "Read test file from recreated pod",
      "explanation": "Should show 'Hello from sts-demo-app-0'. Data survived pod deletion because the PVC was reattached to the new pod. This is StatefulSet's stable storage guarantee.",
      "what_it_does": "Displays contents of persisted file.",
      "next_step": "Test scaling behavior."
    },
    {
      "name": "Step 10: Scale Down",
      "command": "kubectl scale statefulset sts-demo-app --replicas=1 -n scenarios",
      "description": "Scale down to 1 replica",
      "explanation": "StatefulSet scales down in reverse order: sts-demo-app-2 deleted, then sts-demo-app-1. PVCs are retained (not deleted) to preserve data.",
      "what_it_does": "Reduces replicas to 1.",
      "next_step": "Scale back up."
    },
    {
      "name": "Step 11: Scale Up",
      "command": "kubectl scale statefulset sts-demo-app --replicas=3 -n scenarios",
      "description": "Scale back up to 3 replicas",
      "explanation": "Pods sts-demo-app-1 and sts-demo-app-2 are recreated and reattach their original PVCs. Any data written before scale-down is still there.",
      "what_it_does": "Increases replicas to 3.",
      "next_step": "Scenario complete!"
    },
    {
      "name": "Cleanup: Delete StatefulSet",
      "command": "kubectl delete statefulset sts-demo-app -n scenarios",
      "description": "Delete StatefulSet (PVCs remain)",
      "explanation": "Deletes StatefulSet and pods, but PVCs persist by design. You must manually delete PVCs to free storage.",
      "what_it_does": "Removes StatefulSet and pods.",
      "next_step": "Delete PVCs to complete cleanup.",
      "cleanup": true
    },
    {
      "name": "Cleanup: Delete PVCs",
      "command": "kubectl delete pvc -l app=sts-demo-app -n scenarios",
      "description": "Delete PersistentVolumeClaims",
      "explanation": "Deletes all PVCs created by the StatefulSet. This frees storage but data is lost.",
      "what_it_does": "Removes all StatefulSet PVCs.",
      "next_step": "Delete headless service.",
      "cleanup": true
    },
    {
      "name": "Cleanup: Delete Service",
      "command": "kubectl delete -f k8s-scenarios/10-statefulset-operations/service.yaml -n scenarios",
      "description": "Delete headless service",
      "explanation": "Removes the headless service.",
      "what_it_does": "Deletes service.",
      "next_step": "Cleanup complete!",
      "cleanup": true
    }
  ]
}