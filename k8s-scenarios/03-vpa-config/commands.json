{
  "scenario_id": "03-vpa-config",
  "difficulty": "medium",
  "duration": "25 min",
  "commands": [
    {
      "name": "Step 1: Create Namespace",
      "command": "kubectl create namespace scenarios --dry-run=client -o yaml | kubectl apply -f -",
      "description": "Create scenarios namespace",
      "explanation": "Creates the scenarios namespace where all scenario resources will live.",
      "what_it_does": "Creates 'scenarios' namespace if it doesn't exist.",
      "next_step": "Deploy application for VPA to analyze."
    },
    {
      "name": "Step 2: Check VPA Installation",
      "command": "kubectl get crd verticalpodautoscalers.autoscaling.k8s.io",
      "description": "Verify VPA is installed in cluster",
      "explanation": "VPA requires the VPA controller to be installed. This checks if the VPA Custom Resource Definition exists. If not found, you'll need to install VPA first.",
      "what_it_does": "Checks if VPA CRD is available in the cluster.",
      "next_step": "If VPA is installed, deploy the application. If not, install VPA first."
    },
    {
      "name": "Step 3: Deploy Application",
      "command": "kubectl apply -f deployment.yaml -n scenarios",
      "description": "Deploy application with initial resource requests",
      "explanation": "Deploys application with intentionally low resource requests (100m CPU, 50Mi memory) to demonstrate VPA recommendations. The app has higher limits (500m CPU, 500Mi memory) allowing it to use more resources.",
      "what_it_does": "Creates vpa-demo-app deployment and VPA resource in scenarios namespace.",
      "next_step": "Wait for pods to start, then check VPA status."
    },
    {
      "name": "Step 4: Check VPA Status",
      "command": "kubectl get vpa vpa-demo -n scenarios",
      "description": "View VPA resource",
      "explanation": "Shows the VPA resource. Initially, it needs time to gather metrics and generate recommendations. The MODE shows 'Off' meaning it provides recommendations only without automatically applying them.",
      "what_it_does": "Displays VPA with its mode and target deployment.",
      "next_step": "VPA is monitoring. Generate some load to create usage patterns."
    },
    {
      "name": "Step 5: Generate Application Load",
      "command": "kubectl run load-gen --rm -i --tty --image=busybox --restart=Never -n scenarios -- /bin/sh -c \"for i in {1..300}; do wget -q -O- http://vpa-demo-app; sleep 1; done\"",
      "description": "Generate load for 5 minutes to create usage patterns",
      "explanation": "Runs 300 requests over 5 minutes to create CPU/memory usage patterns. VPA analyzes historical usage to generate recommendations. The longer it runs, the more accurate the recommendations.",
      "what_it_does": "Creates temporary pod that makes HTTP requests to generate resource usage.",
      "next_step": "Let this run for 5 minutes. VPA needs time to collect metrics."
    },
    {
      "name": "Step 6: View VPA Recommendations",
      "command": "kubectl describe vpa vpa-demo -n scenarios",
      "description": "View detailed VPA recommendations",
      "explanation": "After several minutes, VPA provides recommendations under 'Container Recommendations'. You'll see Lower Bound, Target, Uncapped Target, and Upper Bound for CPU and memory. Target is the recommended value.",
      "what_it_does": "Shows VPA analysis with recommended CPU and memory values based on observed usage.",
      "next_step": "Compare recommendations to current requests (100m CPU, 50Mi memory)."
    },
    {
      "name": "Step 7: View Current Pod Resources",
      "command": "kubectl get pods -n scenarios -l app=vpa-demo -o jsonpath='{range .items[*]}{.metadata.name}: {.spec.containers[0].resources.requests}{\"\\n\"}{end}'",
      "description": "Show current resource requests for comparison",
      "explanation": "Displays current CPU and memory requests for vpa-demo pods. Compare these to VPA recommendations to see the difference. VPA likely recommends higher values based on actual usage.",
      "what_it_does": "Extracts and displays resource requests from pod specifications.",
      "next_step": "Note the difference between current requests and VPA recommendations."
    },
    {
      "name": "Step 8: Understanding VPA Modes",
      "command": "kubectl get vpa vpa-demo -n scenarios -o yaml | grep -A 3 updatePolicy",
      "description": "View VPA update policy",
      "explanation": "VPA has three modes: Off (recommendations only), Initial (set resources at pod creation), Auto (recreate pods with new resources). We're using 'Off' to see recommendations without automatic changes. In production, you might use 'Auto' for hands-free optimization.",
      "what_it_does": "Shows VPA's update mode configuration.",
      "next_step": "In production, you can change mode to 'Auto' for automatic right-sizing."
    },
    {
      "name": "Step 9: View VPA Events",
      "command": "kubectl get events -n scenarios --field-selector involvedObject.name=vpa-demo --sort-by='.lastTimestamp'",
      "description": "View VPA-related events",
      "explanation": "Shows events related to VPA operation, including when recommendations were updated and any issues encountered.",
      "what_it_does": "Lists Kubernetes events for the VPA resource.",
      "next_step": "You've seen VPA in action! Now clean up resources."
    },
    {
      "name": "Cleanup: Delete Resources",
      "command": "kubectl delete -f deployment.yaml -n scenarios",
      "description": "Remove VPA demo resources",
      "explanation": "Deletes the deployment, VPA resource, and all pods.",
      "what_it_does": "Removes vpa-demo-app deployment and vpa-demo VPA from scenarios namespace.",
      "next_step": "Cleanup complete! Run validation: ./validate.sh",
      "cleanup": true
    }
  ]
}