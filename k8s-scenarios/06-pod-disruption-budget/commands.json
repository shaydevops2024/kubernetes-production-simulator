{
  "scenario_id": "06-pod-disruption-budget",
  "difficulty": "medium",
  "duration": "20 min",
  "commands": [
    {
      "name": "Step 1: Create Namespace",
      "command": "kubectl create namespace scenarios --dry-run=client -o yaml | kubectl apply -f -",
      "description": "Create scenarios namespace",
      "explanation": "Creates namespace for PDB demonstration.",
      "what_it_does": "Creates 'scenarios' namespace if needed.",
      "next_step": "Deploy application with PDB protection."
    },
    {
      "name": "Step 2: Deploy Application with PDB",
      "command": "kubectl apply -f k8s-scenarios/06-pod-disruption-budget/deployment.yaml -f k8s-scenarios/06-pod-disruption-budget/pdb.yaml -n scenarios",
      "description": "Deploy 3-replica app with PDB requiring minAvailable: 2",
      "explanation": "Creates deployment with 3 replicas and a PodDisruptionBudget ensuring at least 2 pods stay available during voluntary disruptions (like drain, eviction). PDB protects against unsafe operations that would violate availability.",
      "what_it_does": "Creates pdb-demo-app deployment (3 replicas) and pdb-demo PodDisruptionBudget (minAvailable: 2).",
      "next_step": "Verify pods and PDB are running."
    },
    {
      "name": "Step 3: Check Pods",
      "command": "kubectl get pods -n scenarios -l app=pdb-demo -o wide",
      "description": "Verify 3 pods running across nodes",
      "explanation": "Should see 3 Running pods. Note which nodes they're on - we'll try to drain one. The NODE column shows distribution.",
      "what_it_does": "Lists pods with their node assignments.",
      "next_step": "Check PDB status."
    },
    {
      "name": "Step 4: Check PDB Status",
      "command": "kubectl get pdb pdb-demo -n scenarios",
      "description": "View PDB current status",
      "explanation": "ALLOWED DISRUPTIONS shows how many pods can be safely disrupted. With 3 pods and minAvailable=2, allowed disruptions is 1. CURRENT shows healthy pods (should be 3).",
      "what_it_does": "Displays PDB with disruption budget and current pod count.",
      "next_step": "Try draining a node to test PDB protection."
    },
    {
      "name": "Step 5: List Nodes",
      "command": "kubectl get nodes",
      "description": "Identify a node to drain",
      "explanation": "Pick a worker node (not control-plane) to simulate maintenance. Check which node has pdb-demo pods from Step 3.",
      "what_it_does": "Lists all cluster nodes.",
      "next_step": "Attempt to drain a node with 2+ pods (PDB may block it)."
    },
    {
      "name": "Step 6: Attempt Node Drain",
      "command": "kubectl drain <NODE_NAME> --ignore-daemonsets --delete-emptydir-data --timeout=30s",
      "description": "Try to drain node (may be blocked by PDB)",
      "explanation": "If draining this node would leave fewer than 2 pods available, PDB blocks the eviction. If the node has only 1 pod, drain succeeds (2 remain elsewhere). This demonstrates PDB protection. Replace <NODE_NAME> with actual node. May see 'Cannot evict pod as it would violate the pod's disruption budget.'",
      "what_it_does": "Attempts to evict pods from specified node.",
      "next_step": "Observe PDB protection in action."
    },
    {
      "name": "Step 7: Check PDB Events",
      "command": "kubectl describe pdb pdb-demo -n scenarios",
      "description": "View PDB details and events",
      "explanation": "Shows minAvailable, current status, and any disruption events. Events section may show eviction attempts that were blocked by the PDB.",
      "what_it_does": "Displays full PDB details including protection events.",
      "next_step": "Scale up to allow more disruptions."
    },
    {
      "name": "Step 8: Scale Up to Bypass PDB",
      "command": "kubectl scale deployment pdb-demo-app --replicas=5 -n scenarios",
      "description": "Increase replicas to 5",
      "explanation": "With 5 pods and minAvailable=2, up to 3 pods can be disrupted. This allows drain operations while maintaining the minimum. Demonstrates how PDB adapts to replica count.",
      "what_it_does": "Scales deployment from 3 to 5 replicas.",
      "next_step": "Check updated PDB disruption budget."
    },
    {
      "name": "Step 9: Verify Increased Budget",
      "command": "kubectl get pdb pdb-demo -n scenarios",
      "description": "View updated PDB with more allowed disruptions",
      "explanation": "ALLOWED DISRUPTIONS should now be 3 (5 current - 2 minAvailable). With more replicas, cluster operations become safer.",
      "what_it_does": "Shows PDB status with increased disruption capacity.",
      "next_step": "If you cordoned a node, uncordon it now."
    },
    {
      "name": "Step 10: Uncordon Node (if needed)",
      "command": "kubectl uncordon <NODE_NAME>",
      "description": "Remove scheduling restriction from node",
      "explanation": "If you successfully cordoned/drained a node, uncordon it to restore normal operations. Replace <NODE_NAME> with the node you drained.",
      "what_it_does": "Makes node schedulable again.",
      "next_step": "Review what you learned in this scenario.",
    },
    {
      "name": "Step 11: Summary - What You Learned",
      "command": "echo '=== Pod Disruption Budget Scenario Complete ==='",
      "description": "Review key concepts and commands used",
      "explanation": "ðŸŽ“ **What You Learned:**\n\n**Concepts:**\n- PodDisruptionBudgets (PDB) protect application availability during voluntary disruptions\n- minAvailable ensures minimum pods stay running during maintenance\n- PDB prevents unsafe node drains that would violate availability requirements\n- Scaling affects allowed disruptions (more replicas = more allowed disruptions)\n- PDB adapts dynamically to replica count changes\n\n**Commands Used:**\n1. `kubectl create namespace` - Create namespace for resources\n2. `kubectl apply -f` - Deploy resources (Deployment, PDB) from YAML\n3. `kubectl get pods -o wide` - View pods with node assignments\n4. `kubectl get pdb` - Check PDB status and allowed disruptions\n5. `kubectl get nodes` - List cluster nodes\n6. `kubectl drain <NODE>` - Attempt to evict pods from node (respects PDB)\n7. `kubectl describe pdb` - View detailed PDB info and events\n8. `kubectl scale deployment --replicas=N` - Change replica count\n9. `kubectl uncordon <NODE>` - Re-enable scheduling on node\n\n**Key Takeaways:**\nâœ… PDB protects critical services during cluster maintenance\nâœ… Use minAvailable for absolute requirements (e.g., \"always keep 2 running\")\nâœ… PDB only protects against voluntary disruptions (drain, evict), not node failures\nâœ… Scale up before maintenance to increase disruption budget\nâœ… Always set PDB for production workloads to prevent unexpected downtime",
      "what_it_does": "Displays summary of learning outcomes and commands.",
      "next_step": "Ready for cleanup!",
      "show_yaml": true
    },
    {
      "name": "Cleanup: Delete Resources",
      "command": "kubectl delete -f k8s-scenarios/06-pod-disruption-budget/deployment.yaml -f k8s-scenarios/06-pod-disruption-budget/pdb.yaml -n scenarios",
      "description": "Remove deployment and PDB",
      "explanation": "Deletes both deployment and PodDisruptionBudget.",
      "what_it_does": "Removes pdb-demo-app deployment and pdb-demo PDB.",
      "next_step": "Cleanup complete!",
      "cleanup": true
    }
  ]
}