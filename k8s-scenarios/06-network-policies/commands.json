{
  "scenario_id": "06-network-policies",
  "difficulty": "medium",
  "duration": "25 min",
  "commands": [
    {
      "name": "Step 1: Create Namespace",
      "command": "kubectl create namespace scenarios --dry-run=client -o yaml | kubectl apply -f -",
      "description": "Create scenarios namespace",
      "explanation": "Creates namespace for network policy testing.",
      "what_it_does": "Creates 'scenarios' namespace if needed.",
      "next_step": "Deploy backend application to test network policies."
    },
    {
      "name": "Step 2: Deploy Backend",
      "command": "kubectl apply -f k8s-scenarios/06-network-policies/deployment.yaml -f k8s-scenarios/06-network-policies/service.yaml -f k8s-scenarios/06-network-policies/network-policy.yaml -n scenarios",
      "description": "Deploy backend deployment, service, and NetworkPolicy",
      "explanation": "Creates backend deployment with labels 'app: netpol-demo' and 'role: backend', a service to access it, and a NetworkPolicy that restricts access. The NetworkPolicy will only allow pods with 'role: frontend' label to connect.",
      "what_it_does": "Creates netpol-demo-app deployment, netpol-demo-service, and netpol-demo-policy NetworkPolicy.",
      "next_step": "Verify backend is running."
    },
    {
      "name": "Step 3: Check Backend Pods",
      "command": "kubectl get pods -n scenarios -l app=netpol-demo",
      "description": "Verify backend pods are running",
      "explanation": "Should see 2 backend pods in Running state. These will be our protected backend that we'll control access to.",
      "what_it_does": "Lists backend application pods.",
      "next_step": "Test connectivity from unlabeled pod (should be blocked)."
    },
    {
      "name": "Step 4: Test Access (Unlabeled Pod - Should Fail)",
      "command": "kubectl run test-unauthorized --rm -i --tty --image=busybox:1.28 -n scenarios -- wget -qO- --timeout=2 http://netpol-demo-service || echo 'Connection blocked as expected'",
      "description": "Test if pod without 'role: frontend' label is blocked",
      "explanation": "Creates temporary pod without any role label and tries to connect to backend. NetworkPolicy blocks this because the pod lacks 'role: frontend' label. Should timeout/fail.",
      "what_it_does": "Attempts HTTP request from unlabeled pod (should be blocked by NetworkPolicy).",
      "next_step": "Access blocked! Now test with authorized frontend label."
    },
    {
      "name": "Step 5: Test Access (Frontend Pod - Should Succeed)",
      "command": "kubectl run test-authorized --rm -i --tty --labels=role=frontend --image=busybox:1.28 -n scenarios -- wget -qO- --timeout=2 http://netpol-demo-service",
      "description": "Test if pod WITH 'role: frontend' label can access backend",
      "explanation": "This pod has 'role: frontend' label, matching the NetworkPolicy allow rule. Connection should succeed with HTTP 200 response from nginx backend.",
      "what_it_does": "Attempts HTTP request from frontend-labeled pod (should succeed).",
      "next_step": "Access allowed! NetworkPolicy is working correctly."
    },
    {
      "name": "Step 6: Describe NetworkPolicy",
      "command": "kubectl describe networkpolicy netpol-demo-policy -n scenarios",
      "description": "View detailed NetworkPolicy configuration",
      "explanation": "Shows podSelector (which pods the policy applies to: app=netpol-demo, role=backend) and ingress rules (who can connect: role=frontend). This creates a security boundary - only frontend pods can reach backend.",
      "what_it_does": "Displays full NetworkPolicy specification and status.",
      "next_step": "Understand the policy rules."
    },
    {
      "name": "Step 7: View Policy YAML",
      "command": "kubectl get networkpolicy netpol-demo-policy -n scenarios -o yaml",
      "description": "See NetworkPolicy in YAML format",
      "explanation": "Shows the complete policy: podSelector targets app=netpol-demo and role=backend, policyTypes: Ingress restricts incoming traffic, ingress allows from podSelector role=frontend. Default behavior is deny-all unless explicitly allowed.",
      "what_it_does": "Displays NetworkPolicy as YAML for understanding structure.",
      "next_step": "Test one more time to confirm behavior."
    },
    {
      "name": "Step 8: Verify Policy Enforcement",
      "command": "kubectl run verify-block --rm -i --tty --image=busybox:1.28 -n scenarios -- sh -c 'echo Testing connection... && wget -qO- --timeout=2 http://netpol-demo-service || echo BLOCKED' | grep -E 'BLOCKED|HTTP'",
      "description": "Final verification that unlabeled pods are blocked",
      "explanation": "One more test to confirm: pods without the correct label cannot access the backend. This proves network segmentation is working.",
      "what_it_does": "Attempts connection and confirms it's blocked.",
      "next_step": "Scenario complete! Network segmentation achieved."
    },
    {
      "name": "Cleanup: Delete All Resources",
      "command": "kubectl delete -f k8s-scenarios/06-network-policies/deployment.yaml -f k8s-scenarios/06-network-policies/service.yaml -f k8s-scenarios/06-network-policies/network-policy.yaml -n scenarios",
      "description": "Remove backend, service, and NetworkPolicy",
      "explanation": "Deletes all resources: backend deployment, service, and network policy.",
      "what_it_does": "Removes all network policy scenario resources.",
      "next_step": "Cleanup complete! Cleanup complete!",
      "cleanup": true
    }
  ]
}