# ArgoCD YAML Explanation - Helm Chart Deployment

This guide explains how ArgoCD deploys applications directly from Helm chart repositories, without needing the Helm CLI or pre-rendered manifests.

---

## ArgoCD + Helm: The Big Picture

Traditional Helm workflow:
```
Developer → helm install/upgrade → Kubernetes
```

GitOps Helm workflow with ArgoCD:
```
Developer → git push (Application CR with helm config) → ArgoCD → Kubernetes
```

ArgoCD has a built-in Helm engine. You don't install Helm on the cluster separately — ArgoCD handles the chart fetching, value merging, and rendering internally.

---

## The Application CR (application.yaml)

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: sc06-helm-nginx
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://charts.bitnami.com/bitnami
    chart: nginx
    targetRevision: "*"
    helm:
      releaseName: sc06-nginx
      values: |
        replicaCount: 2
        service:
          type: ClusterIP
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd-sc-06
  syncPolicy:
    automated:
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
```

---

## source — Helm Chart vs Git Path

This Application source is fundamentally different from previous scenarios:

### Scenario 01-05 source (Git manifests):
```yaml
source:
  repoURL: https://github.com/...git
  path: argocd-scenarios/01-.../manifests
```

### Scenario 06 source (Helm chart):
```yaml
source:
  repoURL: https://charts.bitnami.com/bitnami   # Helm chart repository
  chart: nginx                                    # Chart name (not a file path)
  targetRevision: "*"                             # Chart version
```

---

## Field-by-Field: The Helm Source

### repoURL: https://charts.bitnami.com/bitnami

This is a **Helm chart repository** URL (not a Git URL). Bitnami maintains pre-packaged, production-ready charts here. ArgoCD connects to it and fetches the chart index.

Common Helm repositories:
- `https://charts.bitnami.com/bitnami` — Bitnami charts
- `https://helm.nginx.com/stable` — NGINX charts
- `https://prometheus-community.github.io/helm-charts` — Prometheus stack
- OCI registries like `oci://registry-1.docker.io/bitnamicharts`

### chart: nginx

The chart name within the repository. This is what you'd normally specify in `helm install`. ArgoCD downloads this chart package (`.tgz` file).

### targetRevision: "*"

The chart **version** (not a Git branch). `"*"` means "use the latest available version". In production, pin to a specific version for reproducibility:
```yaml
targetRevision: "15.14.0"   # Pin to exact chart version
```

**Why pin versions?**
- Bitnami updates charts frequently
- `"*"` means every ArgoCD sync might use a different chart version
- Pinning ensures consistent, reproducible deployments

---

## The helm Block — Value Overrides

```yaml
helm:
  releaseName: sc06-nginx
  values: |
    replicaCount: 2
    service:
      type: ClusterIP
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
```

### releaseName: sc06-nginx

The Helm release name — equivalent to the name you'd give in `helm install <name>`. This name appears in Helm's release history and in resource names generated by the chart.

### values: |

Inline Helm values — equivalent to a `values.yaml` file or `--set` flags. The `|` YAML syntax preserves newlines, treating everything below as a multi-line string.

These values override the chart's built-in `values.yaml` defaults:
- `replicaCount: 2` — run 2 nginx pods (chart default is often 1)
- `service.type: ClusterIP` — internal-only service (chart might default to LoadBalancer)
- `resources.*` — set CPU/memory limits appropriate for this cluster

### Alternative: valuesFiles

Instead of inline values, you can reference files:
```yaml
helm:
  valueFiles:
    - values-prod.yaml
    - values-overrides.yaml
```
These files must be in the same Git repository as the Application CR.

---

## What ArgoCD Does Internally

When ArgoCD syncs this Application:

1. **Fetches** the nginx chart from Bitnami repo (latest version)
2. **Merges** chart's `values.yaml` with the inline `values:` block
3. **Renders** all chart templates with merged values (equivalent to `helm template`)
4. **Applies** the rendered YAML to the cluster (like `kubectl apply`)
5. **Tracks** all resources created by this Helm release

ArgoCD doesn't use `helm install` — it renders templates itself and applies them directly. This means:
- ArgoCD manages the resources, not Helm
- `helm ls` won't show this release (ArgoCD bypasses Helm's release tracking)
- Resource ownership is tracked by ArgoCD labels

---

## Resources Created by the Helm Chart

Helm charts often create many more resources than raw manifests. The Bitnami nginx chart creates:
- `Deployment` — the nginx pods
- `Service` — exposes nginx
- `ServiceAccount` — for pod identity
- `ConfigMap` — nginx configuration
- `HorizontalPodAutoscaler` (if enabled)
- Various `PodDisruptionBudget`, etc.

In ArgoCD UI, you'll see the full resource tree — everything the chart creates, organized visually.

---

## Helm in ArgoCD vs Standalone Helm

| Feature | Standalone Helm | ArgoCD + Helm |
|---------|----------------|---------------|
| Trigger | `helm upgrade` | `git push` |
| State tracking | Helm secrets in namespace | ArgoCD Application CR |
| Drift detection | None | Continuous |
| Rollback | `helm rollback` | Git revert + sync |
| Audit trail | None built-in | Git history |
| Multi-cluster | Requires kubeconfig switching | Built-in |

---

## Key Takeaways

- **`chart:` instead of `path:`** tells ArgoCD to use a Helm chart repository, not Git manifests
- **`repoURL`** points to a Helm chart repo (Bitnami, etc.), not GitHub
- **`targetRevision`** is the chart version — use `"*"` for latest, pin for production
- **`helm.releaseName`** sets the Helm release name (for naming resources)
- **`helm.values: |`** provides inline value overrides (same as `-f values.yaml`)
- ArgoCD renders Helm templates internally — no separate Helm CLI needed
- GitOps applies to Helm too — all configuration lives in the Application CR in Git
