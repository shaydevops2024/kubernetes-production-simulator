# ============================================================
#  ChatFlow — nginx API Gateway & WebSocket Proxy
#  All services are proxied through this single entry point.
# ============================================================

upstream chat_service         { server chat-service:8020; }
upstream presence_service     { server presence-service:8021; }
upstream notification_service { server notification-service:8022; }
upstream file_service         { server file-service:8023; }
upstream frontend             { server frontend:80; }

server {
    listen 80;

    # ── WebSocket endpoint (must come before /api/chat) ──────────────────────────
    # WebSocket requires special proxy headers.
    # In Kubernetes, you'll need:
    #   nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    #   nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    #   nginx.ingress.kubernetes.io/configuration-snippet: |
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection "upgrade";
    location /ws/ {
        proxy_pass         http://chat_service;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # ── Chat REST API ─────────────────────────────────────────────────────────────
    # chat-service routes are at root: /rooms, /health, etc.
    # nginx strips /api/chat/ → sends bare path to service.
    location /api/chat/ {
        proxy_pass       http://chat_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Presence API ──────────────────────────────────────────────────────────────
    # presence-service routes have a /presence/ prefix:
    #   GET  /presence                     → list online users
    #   POST /presence/{user_id}/heartbeat → stay online
    #   etc.
    # Two location blocks handle both the no-slash and sub-path cases:

    location = /api/presence {
        # GET /api/presence → GET /presence (list all online users)
        proxy_pass       http://presence_service/presence;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/presence/ {
        # /api/presence/shay/heartbeat → http://presence_service/presence/shay/heartbeat
        proxy_pass       http://presence_service/presence/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Notifications API ─────────────────────────────────────────────────────────
    # notification-service routes have a /notifications/ prefix:
    #   POST  /notifications
    #   GET   /notifications/{user_id}/unread-count
    #   etc.

    location = /api/notifications {
        # POST /api/notifications → POST /notifications (create notification)
        proxy_pass       http://notification_service/notifications;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/notifications/ {
        # /api/notifications/shay/unread-count → http://notification_service/notifications/shay/unread-count
        proxy_pass       http://notification_service/notifications/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ── Files API ─────────────────────────────────────────────────────────────────
    # file-service routes are at root: /upload, /files, /{id}/download, /health
    location /api/files/ {
        proxy_pass          http://file_service/;
        proxy_set_header    Host $host;
        proxy_set_header    X-Real-IP $remote_addr;
        client_max_body_size 15m;  # allow up to 15MB uploads
    }

    # ── Frontend ──────────────────────────────────────────────────────────────────
    location / {
        proxy_pass       http://frontend;
        proxy_set_header Host $host;
    }
}
