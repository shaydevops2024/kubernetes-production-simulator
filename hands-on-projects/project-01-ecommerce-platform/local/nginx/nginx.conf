upstream product_service   { server product-service:8001; }
upstream cart_service      { server cart-service:8002; }
upstream order_service     { server order-service:8003; }
upstream payment_service   { server payment-service:8004; }
upstream inventory_service { server inventory-service:8005; }

server {
    listen 80;
    server_name _;

    # --- Frontend ---
    location / {
        proxy_pass         http://frontend:80;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
    }

    # --- API Routes ---
    location /api/products {
        rewrite ^/api/products(/.*)? /products$1 break;
        proxy_pass         http://product_service;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_read_timeout 30s;
    }

    location /api/cart {
        rewrite ^/api/cart(/.*)? /cart$1 break;
        proxy_pass         http://cart_service;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_read_timeout 30s;
    }

    location /api/orders {
        rewrite ^/api/orders(/.*)? /orders$1 break;
        proxy_pass         http://order_service;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_read_timeout 60s;
    }

    location /api/payments {
        rewrite ^/api/payments(/.*)? /payments$1 break;
        proxy_pass         http://payment_service;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_read_timeout 30s;
    }

    location /api/inventory {
        rewrite ^/api/inventory(/.*)? /inventory$1 break;
        proxy_pass         http://inventory_service;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_read_timeout 30s;
    }

    # --- Health checks (service-level) ---
    location /api/product-service/health {
        rewrite ^/api/product-service/health /health break;
        proxy_pass http://product_service;
    }
    location /api/cart-service/health {
        rewrite ^/api/cart-service/health /health break;
        proxy_pass http://cart_service;
    }
    location /api/order-service/health {
        rewrite ^/api/order-service/health /health break;
        proxy_pass http://order_service;
    }
    location /api/payment-service/health {
        rewrite ^/api/payment-service/health /health break;
        proxy_pass http://payment_service;
    }
    location /api/inventory-service/health {
        rewrite ^/api/inventory-service/health /health break;
        proxy_pass http://inventory_service;
    }
}
