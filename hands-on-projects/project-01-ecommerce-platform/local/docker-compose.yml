version: '3.9'

# ============================================================
#  ShopCloud — Local Development Stack
#  Run: docker compose up --build
#  UI:  http://localhost:8088
# ============================================================

services:

  # ── Databases ──────────────────────────────────────────────

  postgres-products:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: products_db
      POSTGRES_USER: shop
      POSTGRES_PASSWORD: shoppass
    volumes:
      - products_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shop -d products_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-orders:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: orders_db
      POSTGRES_USER: shop
      POSTGRES_PASSWORD: shoppass
    volumes:
      - orders_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shop -d orders_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-payments:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: payments_db
      POSTGRES_USER: shop
      POSTGRES_PASSWORD: shoppass
    volumes:
      - payments_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shop -d payments_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-inventory:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: inventory_db
      POSTGRES_USER: shop
      POSTGRES_PASSWORD: shoppass
    volumes:
      - inventory_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shop -d inventory_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ── Microservices ──────────────────────────────────────────

  product-service:
    build:
      context: ../app/product-service
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://shop:shoppass@postgres-products:5432/products_db
      PORT: "8001"
    depends_on:
      postgres-products:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  cart-service:
    build:
      context: ../app/cart-service
      dockerfile: Dockerfile
    environment:
      PRODUCT_SERVICE_URL: http://product-service:8001
      PORT: "8002"
    depends_on:
      product-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  payment-service:
    build:
      context: ../app/payment-service
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://shop:shoppass@postgres-payments:5432/payments_db
      PORT: "8004"
    depends_on:
      postgres-payments:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  inventory-service:
    build:
      context: ../app/inventory-service
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://shop:shoppass@postgres-inventory:5432/inventory_db
      PORT: "8005"
    depends_on:
      postgres-inventory:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8005/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  order-service:
    build:
      context: ../app/order-service
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://shop:shoppass@postgres-orders:5432/orders_db
      CART_SERVICE_URL: http://cart-service:8002
      PAYMENT_SERVICE_URL: http://payment-service:8004
      INVENTORY_SERVICE_URL: http://inventory-service:8005
      PORT: "8003"
    depends_on:
      postgres-orders:
        condition: service_healthy
      cart-service:
        condition: service_healthy
      payment-service:
        condition: service_healthy
      inventory-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  # ── Frontend ───────────────────────────────────────────────

  frontend:
    build:
      context: ../app/frontend
      dockerfile: Dockerfile
    depends_on:
      - product-service

  # ── API Gateway (nginx) ────────────────────────────────────

  gateway:
    image: nginx:alpine
    ports:
      - "8088:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - product-service
      - cart-service
      - order-service
      - payment-service
      - inventory-service
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost/api/product-service/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  products_db_data:
  orders_db_data:
  payments_db_data:
  inventory_db_data:
