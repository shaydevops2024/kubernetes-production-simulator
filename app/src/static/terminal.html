<!-- File: app/src/static/terminal.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K8s Interactive Terminal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .terminal-header {
            background: #2d2d2d;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #3e3e3e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .terminal-title {
            font-size: 1rem;
            font-weight: 600;
            color: #4ec9b0;
        }

        .scenario-name {
            font-size: 0.9rem;
            color: #9cdcfe;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-secondary {
            background: #3e3e3e;
            color: #cccccc;
        }

        .btn-secondary:hover {
            background: #4e4e4e;
        }

        .btn-cancel {
            background: #f85149;
            color: white;
            display: none;
        }

        .btn-cancel:hover {
            background: #da3633;
        }

        .btn-cancel.visible {
            display: inline-block;
        }

        .btn-validate {
            background: #238636;
            color: white;
        }

        .btn-validate:hover {
            background: #2ea043;
        }

        .btn-restart {
            background: #d97706;
            color: white;
        }

        .btn-restart:hover {
            background: #ea580c;
        }

        .btn-back {
            background: #0e639c;
            color: white;
        }

        .btn-back:hover {
            background: #1177bb;
        }

        .terminal-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .commands-sidebar {
            width: 320px;
            background: #3a3a3a;
            border-right: 1px solid #4e4e4e;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            order: 0;
        }

        .sidebar-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #4e4e4e;
            background: #454545;
        }

        .sidebar-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e0e0e0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: #5e5e5e;
            border-radius: 4px;
        }

        .command-item {
            background: #4e4e4e;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            position: relative;
        }

        .command-item:hover {
            background: #5e5e5e;
            border-left-color: #0e639c;
        }

        .command-item.executed {
            background: #2d4a2d;
            border-left-color: #3fb950;
        }

        .command-item.executed:hover {
            background: #355835;
        }

        .command-item-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .command-checkmark {
            color: #3fb950;
            font-size: 1rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .command-item.executed .command-checkmark {
            opacity: 1;
        }

        .command-item-text {
            color: #ffffff;
            font-size: 0.85rem;
            font-weight: 600;
            word-break: break-all;
            flex: 1;
        }

        .command-item-desc {
            color: #808080;
            font-size: 0.75rem;
            font-style: italic;
            margin-left: 1.5rem;
            line-height: 1.4;
        }

        .terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            order: 1;
        }

        .terminal-output {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            background: #1e1e1e;
        }

        .terminal-output::-webkit-scrollbar {
            width: 12px;
        }

        .terminal-output::-webkit-scrollbar-track {
            background: #252526;
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: #3e3e3e;
            border-radius: 6px;
        }

        .terminal-output::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        .terminal-line {
            margin-bottom: 0.5rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .welcome-message {
            color: #4ec9b0;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .tip-message {
            color: #ce9178;
            margin-bottom: 1.5rem;
        }

        .command-line {
            display: flex;
            margin-bottom: 0.25rem;
        }

        .prompt {
            color: #4ec9b0;
            font-weight: 600;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }

        .command-text {
            color: #9cdcfe;
        }

        .output-text {
            color: #cccccc;
            padding-left: 0;
        }

        .error-text {
            color: #f48771;
        }

        .success-text {
            color: #89d185;
        }

        .warning-text {
            color: #dcdcaa;
        }

        .loading-indicator {
            color: #ce9178;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .terminal-input-area {
            background: #252526;
            border-top: 1px solid #3e3e3e;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .input-prompt {
            color: #4ec9b0;
            font-weight: 600;
            flex-shrink: 0;
        }

        #command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #9cdcfe;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            caret-color: #9cdcfe;
        }

        #command-input::placeholder {
            color: #6a6a6a;
        }

        #command-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 968px) {
            .commands-sidebar {
                display: none;
            }
        }

        .empty-state {
            text-align: center;
            color: #858585;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <div class="terminal-header">
        <div class="header-left">
            <div class="terminal-title">K8s Interactive Terminal</div>
            <div class="scenario-name" id="scenario-info">Loading...</div>
        </div>
        <div class="header-actions">
            <button class="btn btn-cancel" id="cancel-btn" onclick="cancelCommand()">‚èπ Cancel (Ctrl+C)</button>
            <button class="btn btn-secondary" onclick="clearTerminal()">Clear</button>
            <button class="btn btn-restart" onclick="resetScenario()">üîÑ Restart Scenario</button>
            <button class="btn btn-validate" onclick="validateScenario()">‚úì Validate</button>
            <button class="btn btn-back" onclick="window.location.href='/static/scenarios.html'">‚Üê Back</button>
        </div>
    </div>

    <div class="terminal-main">
        <div class="commands-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Available Commands</div>
            </div>
            <div class="sidebar-content" id="commands-list">
                <div class="loading-indicator">Loading commands...</div>
            </div>
        </div>

        <div class="terminal-container">
            <div class="terminal-output" id="terminal-output">
                <div class="welcome-message">Welcome to K8s Interactive Terminal</div>
                <div class="tip-message">Tip: Click commands on the left or type directly. Use Up/Down arrows for history.</div>
                <div class="loading-indicator">Loading scenario...</div>
            </div>

            <div class="terminal-input-area">
                <span class="input-prompt">claude@k8s-simulator:~$</span>
                <input 
                    type="text" 
                    id="command-input" 
                    placeholder="Type your command and press Enter..."
                    autocomplete="off"
                    spellcheck="false"
                    autofocus
                />
            </div>
        </div>
    </div>

    <script>
        const output = document.getElementById('terminal-output');
        const input = document.getElementById('command-input');
        const commandsList = document.getElementById('commands-list');
        const scenarioInfo = document.getElementById('scenario-info');
        const cancelBtn = document.getElementById('cancel-btn');
        
        let scenarioId = new URLSearchParams(window.location.search).get('scenario');
        let commandHistory = [];
        let historyIndex = -1;
        let currentCommands = [];
        let currentScenario = null;
        let currentAbortController = null;
        let isCommandRunning = false;
        let executedCommands = new Set();

        async function loadScenario() {
            if (!scenarioId) {
                addLine('Error: No scenario specified', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/scenarios/${scenarioId}`);
                const scenario = await response.json();
                
                currentScenario = scenario;
                scenarioInfo.textContent = scenario.name;
                currentCommands = scenario.commands || [];
                
                clearOutput();
                addLine('Welcome to K8s Interactive Terminal', 'success');
                addLine(`Scenario: ${scenario.name}`, 'success');
                addLine('');
                
                // Auto-reset scenario on page load (F5 behavior)
                addLine('Resetting scenario...', 'warning');
                const resetResult = await silentResetScenario();
                if (resetResult.success) {
                    addLine('‚úì Scenario reset complete', 'success');
                } else {
                    addLine('‚ö† Scenario reset not available (no cleanup script)', 'warning');
                }
                addLine('');
                
                addLine('Tip: Click commands on the left or type ANY command!', 'warning');
                addLine('     Executed commands will show a green checkmark ‚úì', 'warning');
                addLine('     Press Ctrl+C or click Cancel to stop running commands', 'warning');
                addLine('     Click "üîÑ Restart Scenario" to reset at any time', 'warning');
                addLine('     Click "‚úì Validate" when done to check your work', 'warning');
                addLine('');
                
                displayCommands(currentCommands);
                
            } catch (error) {
                console.error('Error loading scenario:', error);
                addLine(`Error loading scenario: ${error.message}`, 'error');
            }
        }

        function displayCommands(commands) {
            if (commands.length === 0) {
                commandsList.innerHTML = '<div class="empty-state">No commands available</div>';
                return;
            }

            commandsList.innerHTML = commands.map((cmd, index) => `
                <div class="command-item" id="cmd-${index}" onclick="executeCommandFromSidebar('${escapeQuotes(cmd.command)}', ${index})">
                    <div class="command-item-header">
                        <span class="command-checkmark">‚úì</span>
                        <div class="command-item-text">${escapeHtml(cmd.command)}</div>
                    </div>
                    ${cmd.description ? `<div class="command-item-desc">${escapeHtml(cmd.description)}</div>` : ''}
                </div>
            `).join('');
        }

        function markCommandExecuted(index) {
            const cmdElement = document.getElementById(`cmd-${index}`);
            if (cmdElement) {
                cmdElement.classList.add('executed');
                executedCommands.add(index);
            }
        }

        function addLine(text, type = 'normal') {
            const line = document.createElement('div');
            line.className = 'terminal-line';
            
            if (type === 'command') {
                line.innerHTML = `<div class="command-line"><span class="prompt">claude@k8s-simulator:~$</span><span class="command-text">${escapeHtml(text)}</span></div>`;
            } else {
                const className = type === 'error' ? 'error-text' : 
                                type === 'success' ? 'success-text' : 
                                type === 'warning' ? 'warning-text' : 
                                'output-text';
                line.innerHTML = `<span class="${className}">${escapeHtml(text)}</span>`;
            }
            
            output.appendChild(line);
            scrollToBottom();
        }

        async function executeCommandFromSidebar(cmd, index) {
            await executeCommand(cmd);
            markCommandExecuted(index);
        }

        async function executeCommand(cmd) {
            const trimmedCmd = cmd.trim();
            if (!trimmedCmd) return;

            if (isCommandRunning) {
                addLine('Another command is already running. Please wait or press Ctrl+C to cancel.', 'warning');
                return;
            }

            commandHistory.push(trimmedCmd);
            historyIndex = commandHistory.length;
            addLine(trimmedCmd, 'command');
            input.value = '';

            const loadingLine = document.createElement('div');
            loadingLine.className = 'terminal-line loading-indicator';
            loadingLine.textContent = 'Executing...';
            output.appendChild(loadingLine);
            scrollToBottom();

            isCommandRunning = true;
            input.disabled = true;
            cancelBtn.classList.add('visible');

            currentAbortController = new AbortController();

            try {
                const result = await executeRealCommand(trimmedCmd, currentAbortController.signal);
                
                loadingLine.remove();
                
                if (result.cancelled) {
                    addLine('^C', 'warning');
                    addLine('Command cancelled', 'warning');
                } else {
                    if (result.stdout) {
                        result.stdout.split('\n').forEach(line => {
                            addLine(line);
                        });
                    }
                    
                    if (result.stderr) {
                        result.stderr.split('\n').forEach(line => {
                            if (line.trim()) {
                                addLine(line, 'error');
                            }
                        });
                    }
                }
                
                addLine('');
                
            } catch (error) {
                loadingLine.remove();
                if (error.name === 'AbortError') {
                    addLine('^C', 'warning');
                    addLine('Command cancelled', 'warning');
                } else {
                    addLine(`Error: ${error.message}`, 'error');
                }
                addLine('');
            } finally {
                isCommandRunning = false;
                input.disabled = false;
                input.focus();
                cancelBtn.classList.remove('visible');
                currentAbortController = null;
            }
        }

        async function executeRealCommand(cmd, signal) {
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        command: cmd
                    }),
                    signal: signal
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                if (error.name === 'AbortError') {
                    return { cancelled: true };
                }
                console.error('Command execution error:', error);
                return {
                    stdout: '',
                    stderr: error.message,
                    returncode: 1
                };
            }
        }

        function cancelCommand() {
            if (currentAbortController && isCommandRunning) {
                currentAbortController.abort();
            }
        }

        async function silentResetScenario() {
            if (!scenarioId) {
                return { success: false, message: "No scenario" };
            }

            try {
                const response = await fetch(`/api/scenarios/${scenarioId}/reset`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    return { success: false, message: `HTTP ${response.status}` };
                }

                const result = await response.json();
                return result;
                
            } catch (error) {
                return { success: false, message: error.message };
            }
        }

        async function resetScenario() {
            if (!scenarioId) {
                addLine('Error: No scenario to reset', 'error');
                return;
            }

            addLine('');
            addLine('========================================', 'warning');
            addLine('RESTARTING SCENARIO...', 'warning');
            addLine('========================================', 'warning');
            addLine('');

            const loadingLine = document.createElement('div');
            loadingLine.className = 'terminal-line loading-indicator';
            loadingLine.textContent = 'Resetting scenario...';
            output.appendChild(loadingLine);
            scrollToBottom();

            try {
                const response = await fetch(`/api/scenarios/${scenarioId}/reset`, {
                    method: 'POST'
                });

                loadingLine.remove();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    addLine('‚úì SCENARIO RESET COMPLETE!', 'success');
                    addLine('');
                    addLine(result.message || 'Scenario has been reset to initial state', 'success');
                    addLine('You can now start the scenario from the beginning', 'success');
                    
                    // Clear executed checkmarks
                    executedCommands.clear();
                    displayCommands(currentCommands);
                } else {
                    addLine('‚ö† RESET COMPLETED WITH WARNINGS', 'warning');
                    addLine('');
                    addLine(result.message || 'Reset may not be available for this scenario', 'warning');
                }
                
                addLine('');
                
            } catch (error) {
                loadingLine.remove();
                addLine(`Reset error: ${error.message}`, 'error');
                addLine('');
            }
        }

        async function validateScenario() {
            if (!scenarioId) {
                addLine('Error: No scenario to validate', 'error');
                return;
            }

            addLine('');
            addLine('========================================', 'warning');
            addLine('VALIDATING SCENARIO...', 'warning');
            addLine('========================================', 'warning');
            addLine('');

            const loadingLine = document.createElement('div');
            loadingLine.className = 'terminal-line loading-indicator';
            loadingLine.textContent = 'Checking your work...';
            output.appendChild(loadingLine);
            scrollToBottom();

            try {
                const response = await fetch(`/api/scenarios/${scenarioId}/validate`, {
                    method: 'POST'
                });

                loadingLine.remove();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    addLine('‚úì VALIDATION PASSED!', 'success');
                    addLine('');
                    if (result.message) {
                        addLine(result.message, 'success');
                    }
                    if (result.checks) {
                        result.checks.forEach(check => {
                            const icon = check.passed ? '‚úì' : '‚úó';
                            const type = check.passed ? 'success' : 'error';
                            addLine(`${icon} ${check.name}`, type);
                        });
                    }
                    
                    // Suggest manual restart
                    addLine('');
                    addLine('üí° Click "üîÑ Restart Scenario" to try again or F5 to reload', 'warning');
                } else {
                    addLine('‚úó VALIDATION FAILED', 'error');
                    addLine('');
                    if (result.message) {
                        addLine(result.message, 'error');
                    }
                    if (result.checks) {
                        result.checks.forEach(check => {
                            const icon = check.passed ? '‚úì' : '‚úó';
                            const type = check.passed ? 'success' : 'error';
                            addLine(`${icon} ${check.name}`, type);
                        });
                    }
                }
                
                addLine('');
                
            } catch (error) {
                loadingLine.remove();
                addLine(`Validation error: ${error.message}`, 'error');
                addLine('');
            }
        }

        function clearTerminal() {
            clearOutput();
            if (currentScenario) {
                addLine('Welcome to K8s Interactive Terminal', 'success');
                addLine(`Scenario: ${currentScenario.name}`, 'success');
                addLine('');
                addLine('Terminal cleared. Type commands or click on the left sidebar.', 'warning');
                addLine('');
            }
        }

        function clearOutput() {
            output.innerHTML = '';
        }

        function scrollToBottom() {
            output.scrollTop = output.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeQuotes(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                executeCommand(input.value);
            } else if (e.ctrlKey && e.key === 'c') {
                e.preventDefault();
                cancelCommand();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    input.value = commandHistory[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    input.value = commandHistory[historyIndex];
                } else {
                    historyIndex = commandHistory.length;
                    input.value = '';
                }
            }
        });

        loadScenario();
    </script>
</body>
</html>